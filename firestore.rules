rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isVerified() { return request.auth.token.email_verified == true; }
    function role(r) { return request.auth.token.role == r; }
    function hasMfa() { return request.auth.token.mfa == true; }

    match /users/{uid} {
      allow read: if isVerified() && request.auth.uid == uid;
      allow write: if isVerified() && request.auth.uid == uid;
    }

    // Themes collection - χρήστες μπορούν να αποθηκεύουν τα δικά τους themes
    // ΠΡΟΣΩΡΙΝΟΣ ΚΑΝΟΝΑΣ: Επιτρέπει anonymous users για development
    match /themes/{themeId} {
      // Ανάγνωση: Όλοι μπορούν να διαβάσουν public themes ή τα δικά τους
      allow read: if resource.data.public == true ||
                     (request.auth != null && resource.data.userId == request.auth.uid) ||
                     (request.auth == null && resource.data.userId == 'anonymous');

      // Δημιουργία: Anonymous users και authenticated users
      allow create: if (request.auth != null &&
                       request.resource.data.userId == request.auth.uid) ||
                      (request.auth == null &&
                       request.resource.data.userId == 'anonymous');

      // Ενημέρωση: Μόνο ο ιδιοκτήτης
      allow update: if (request.auth != null &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid) ||
                      (request.auth == null &&
                       resource.data.userId == 'anonymous' &&
                       request.resource.data.userId == 'anonymous');

      // Διαγραφή: Μόνο ο ιδιοκτήτης
      allow delete: if (request.auth != null &&
                       resource.data.userId == request.auth.uid) ||
                      (request.auth == null &&
                       resource.data.userId == 'anonymous');
    }

    // Factory Color Settings - DEVELOPMENT ONLY: Όλοι μπορούν να διαβάζουν και γράφουν
    match /factoryColorSettings/{settingId} {
      allow read, write: if true; // Πλήρη πρόσβαση για development
    }

    // User Color Settings - DEVELOPMENT ONLY: Όλοι μπορούν να διαβάζουν και γράφουν
    match /userColorSettings/{userId} {
      allow read, write: if true; // Πλήρη πρόσβαση για development
    }

    // Παραδείγματα συλλογών που απαιτούν επαγγελματίες + 2FA για write
    match /projects/{id} {
      allow read:  if isVerified();
      allow write: if isVerified() && hasMfa() && (role('admin') || role('broker') || role('builder'));
    }

    match /admin/{document=**} {
      allow read, write: if isVerified() && hasMfa() && role('admin');
    }
  }
}