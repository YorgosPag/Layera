{"version":3,"sources":["../src/services/MapInitializationService.ts","../src/providers/MapProvider.tsx"],"sourcesContent":["import L from 'leaflet';\r\nimport { LeafletMap, LeafletEvent, MapConfig, MapInitializationOptions } from '../types';\r\n\r\nexport class MapInitializationService {\r\n  private static instance: MapInitializationService;\r\n  private readonly defaultConfig: MapConfig = {\r\n    center: [37.9755, 23.7348], // Athens coordinates\r\n    zoom: 13,\r\n    maxZoom: 18,\r\n    minZoom: 8,\r\n    tileUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\r\n    attribution: 'Â© OpenStreetMap contributors'\r\n  };\r\n\r\n  static getInstance(): MapInitializationService {\r\n    if (!MapInitializationService.instance) {\r\n      MapInitializationService.instance = new MapInitializationService();\r\n    }\r\n    return MapInitializationService.instance;\r\n  }\r\n\r\n  private constructor() {\r\n    this.fixLeafletIconPaths();\r\n  }\r\n\r\n  private fixLeafletIconPaths(): void {\r\n    // Fix Leaflet icon paths for bundled applications\r\n    delete (L.Icon.Default.prototype as unknown as { _getIconUrl?: unknown })._getIconUrl;\r\n    L.Icon.Default.mergeOptions({\r\n      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',\r\n      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',\r\n      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',\r\n    });\r\n  }\r\n\r\n  private addOverlayStyles(): void {\r\n    // Add CSS for floor plan overlay z-index\r\n    if (!document.querySelector('style[data-geomap-overlay]')) {\r\n      const overlayStyles = document.createElement('style');\r\n      overlayStyles.setAttribute('data-geomap-overlay', 'true');\r\n      overlayStyles.textContent = `\r\n        .leaflet-overlay-pane { z-index: 400 !important; }\r\n        .floor-plan-overlay { outline: 2px dashed red; }\r\n      `;\r\n      document.head.appendChild(overlayStyles);\r\n    }\r\n  }\r\n\r\n  public initializeMap(options: MapInitializationOptions): LeafletMap {\r\n    const config = { ...this.defaultConfig, ...options.config };\r\n\r\n    // Clear container safely\r\n    const mapContainer = document.getElementById(options.containerId);\r\n    if (!mapContainer) {\r\n      throw new Error(`Map container with id \"${options.containerId}\" not found`);\r\n    }\r\n\r\n    try {\r\n      mapContainer.innerHTML = '';\r\n    } catch (e) {\r\n      console.warn('Container cleanup warning:', e);\r\n    }\r\n\r\n    // Create map\r\n    const map = L.map(options.containerId, {\r\n      zoomControl: false, // We'll add custom controls later if needed\r\n    }).setView(config.center, config.zoom);\r\n\r\n    // Add tile layer\r\n    L.tileLayer(config.tileUrl, {\r\n      attribution: config.attribution,\r\n      maxZoom: config.maxZoom,\r\n      minZoom: config.minZoom\r\n    }).addTo(map);\r\n\r\n    // Add overlay styles\r\n    this.addOverlayStyles();\r\n\r\n    // Force resize after creation\r\n    setTimeout(() => map.invalidateSize(), 0);\r\n\r\n    return map;\r\n  }\r\n\r\n  public addZoomControl(map: LeafletMap, position: 'topright' | 'topleft' | 'bottomright' | 'bottomleft' = 'topright'): void {\r\n    L.control.zoom({ position }).addTo(map);\r\n  }\r\n\r\n  public addScaleControl(\r\n    map: LeafletMap,\r\n    options: {\r\n      position?: 'topright' | 'topleft' | 'bottomright' | 'bottomleft';\r\n      metric?: boolean;\r\n      imperial?: boolean;\r\n      maxWidth?: number;\r\n    } = {}\r\n  ): void {\r\n    const defaultOptions = {\r\n      position: 'bottomleft' as const,\r\n      metric: true,\r\n      imperial: false,\r\n      maxWidth: 200\r\n    };\r\n\r\n    L.control.scale({ ...defaultOptions, ...options }).addTo(map);\r\n  }\r\n\r\n  public setupEventListeners(\r\n    map: LeafletMap,\r\n    handlers: {\r\n      onMapClick?: (event: LeafletEvent) => void;\r\n      onMapMove?: () => void;\r\n      onMapMoveEnd?: () => void;\r\n      onMapZoomEnd?: () => void;\r\n    }\r\n  ): void {\r\n    if (handlers.onMapClick) {\r\n      map.on('click', handlers.onMapClick);\r\n    }\r\n\r\n    if (handlers.onMapMove) {\r\n      map.on('move', handlers.onMapMove);\r\n    }\r\n\r\n    if (handlers.onMapMoveEnd) {\r\n      map.on('moveend', handlers.onMapMoveEnd);\r\n    }\r\n\r\n    if (handlers.onMapZoomEnd) {\r\n      map.on('zoomend', handlers.onMapZoomEnd);\r\n    }\r\n  }\r\n\r\n  public cleanupMap(map: LeafletMap | null): void {\r\n    if (map) {\r\n      try {\r\n        map.off(); // Remove all event listeners\r\n        map.remove(); // Remove map instance\r\n      } catch (error) {\r\n        console.warn('Error during map cleanup:', error);\r\n      }\r\n    }\r\n  }\r\n}","import React, { createContext, useContext, useRef, useState, useEffect, ReactNode } from 'react';\r\nimport { LeafletMap, LatLngBounds, MapConfig } from '../types';\r\nimport { MapInitializationService } from '../services/MapInitializationService';\r\n\r\ninterface MapContextValue {\r\n  map: LeafletMap | null;\r\n  mapBounds: LatLngBounds | null;\r\n  mapSize: { width: number; height: number };\r\n  isLoading: boolean;\r\n  initializeMap: (containerId: string, config?: Partial<MapConfig>) => Promise<void>;\r\n  cleanupMap: () => void;\r\n}\r\n\r\nconst MapContext = createContext<MapContextValue | undefined>(undefined);\r\n\r\ninterface MapProviderProps {\r\n  children: ReactNode;\r\n  defaultConfig?: Partial<MapConfig>;\r\n}\r\n\r\nexport const MapProvider: React.FC<MapProviderProps> = ({ children, defaultConfig }) => {\r\n  const mapRef = useRef<LeafletMap | null>(null);\r\n  const isComponentMounted = useRef(true);\r\n  const mapInitService = useRef(MapInitializationService.getInstance());\r\n\r\n  const [mapBounds, setMapBounds] = useState<LatLngBounds | null>(null);\r\n  const [mapSize, setMapSize] = useState({ width: 0, height: 0 });\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const updateMapState = () => {\r\n    if (isComponentMounted.current && mapRef.current) {\r\n      const bounds = mapRef.current.getBounds();\r\n      const size = mapRef.current.getSize();\r\n      setMapBounds(bounds);\r\n      setMapSize({ width: size.x, height: size.y });\r\n    }\r\n  };\r\n\r\n  const initializeMap = async (containerId: string, config?: Partial<MapConfig>) => {\r\n    try {\r\n      setIsLoading(true);\r\n\r\n      const mapConfig = { ...defaultConfig, ...config };\r\n      const map = mapInitService.current.initializeMap({\r\n        containerId,\r\n        config: mapConfig as MapConfig\r\n      });\r\n\r\n      mapRef.current = map;\r\n\r\n      // Setup event listeners for state updates\r\n      mapInitService.current.setupEventListeners(map, {\r\n        onMapMove: updateMapState,\r\n        onMapMoveEnd: updateMapState,\r\n        onMapZoomEnd: updateMapState\r\n      });\r\n\r\n      // Initial state update\r\n      updateMapState();\r\n      setIsLoading(false);\r\n    } catch (error) {\r\n      console.error('Failed to initialize map:', error);\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const cleanupMap = () => {\r\n    if (mapRef.current) {\r\n      mapInitService.current.cleanupMap(mapRef.current);\r\n      mapRef.current = null;\r\n    }\r\n  };\r\n\r\n  // Cleanup on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      isComponentMounted.current = false;\r\n      cleanupMap();\r\n    };\r\n  }, []);\r\n\r\n  const value: MapContextValue = {\r\n    map: mapRef.current,\r\n    mapBounds,\r\n    mapSize,\r\n    isLoading,\r\n    initializeMap,\r\n    cleanupMap\r\n  };\r\n\r\n  return (\r\n    <MapContext.Provider value={value}>\r\n      {children}\r\n    </MapContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useMap = (): MapContextValue => {\r\n  const context = useContext(MapContext);\r\n  if (context === undefined) {\r\n    throw new Error('useMap must be used within a MapProvider');\r\n  }\r\n  return context;\r\n};"],"mappings":"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","names":[]}