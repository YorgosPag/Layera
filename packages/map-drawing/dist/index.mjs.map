{"version":3,"sources":["../src/services/DrawingService.ts","../src/hooks/useDrawing.ts"],"sourcesContent":["import L from 'leaflet';\r\nimport { LeafletMap, LeafletEvent, DrawnArea } from '@layera/map-core';\r\nimport { DrawingMode, DrawingState, DrawingEventHandlers, DrawingServiceConfig } from '../types';\r\n\r\nexport class DrawingService {\r\n  private map: LeafletMap | null = null;\r\n  private state: DrawingState = {\r\n    activeMode: 'none',\r\n    currentPolygon: null,\r\n    polygonPoints: [],\r\n    drawnAreas: []\r\n  };\r\n  private handlers: DrawingEventHandlers = {};\r\n  private config: DrawingServiceConfig;\r\n\r\n  constructor(config: DrawingServiceConfig = {}) {\r\n    this.config = {\r\n      enablePolygon: true,\r\n      enableMarker: true,\r\n      defaultCategory: 'real_estate',\r\n      ...config\r\n    };\r\n  }\r\n\r\n  public initialize(map: LeafletMap, handlers: DrawingEventHandlers = {}): void {\r\n    this.map = map;\r\n    this.handlers = handlers;\r\n    this.setupEventListeners();\r\n  }\r\n\r\n  private setupEventListeners(): void {\r\n    if (!this.map) return;\r\n\r\n    this.map.on('click', this.handleMapClick.bind(this));\r\n    this.map.on('dblclick', this.handleDoubleClick.bind(this));\r\n  }\r\n\r\n  private handleMapClick(e: LeafletEvent): void {\r\n    if (!this.map || !e.latlng) return;\r\n\r\n    const { lat, lng } = e.latlng;\r\n\r\n    if (this.state.activeMode === 'marker') {\r\n      this.addMarker(lat, lng);\r\n    } else if (this.state.activeMode === 'polygon') {\r\n      this.addPolygonPoint(lat, lng);\r\n    }\r\n  }\r\n\r\n  private handleDoubleClick(): void {\r\n    if (this.state.activeMode === 'polygon') {\r\n      this.finishPolygon();\r\n    }\r\n  }\r\n\r\n  private addMarker(lat: number, lng: number): void {\r\n    if (!this.map) return;\r\n\r\n    try {\r\n      L.marker([lat, lng]).addTo(this.map);\r\n\r\n      const area: DrawnArea = {\r\n        id: Date.now().toString(),\r\n        type: 'marker',\r\n        coordinates: [[lat, lng]],\r\n        name: `${this.config.defaultCategory === 'real_estate' ? 'Property' : 'Job'} ${this.state.drawnAreas.length + 1}`,\r\n        nameTemplate: this.config.defaultCategory === 'real_estate' ? 'realEstate' : 'job',\r\n        nameNumber: this.state.drawnAreas.length + 1,\r\n        category: this.config.defaultCategory || 'real_estate',\r\n        isVisible: true,\r\n        opacity: 1\r\n      };\r\n\r\n      this.state.drawnAreas.push(area);\r\n      this.handlers.onAreaCreated?.(area);\r\n\r\n      // Reset drawing mode\r\n      this.setDrawingMode('none');\r\n    } catch (error) {\r\n      console.warn('Error adding marker:', error);\r\n    }\r\n  }\r\n\r\n  private addPolygonPoint(lat: number, lng: number): void {\r\n    if (!this.map) return;\r\n\r\n    try {\r\n      this.state.polygonPoints.push([lat, lng]);\r\n\r\n      // Create new polygon on first point\r\n      if (this.state.polygonPoints.length === 1) {\r\n        const style = {\r\n          color: '#3b82f6',\r\n          fillColor: '#3b82f6',\r\n          fillOpacity: 0.3\r\n        };\r\n\r\n        this.state.currentPolygon = L.polygon(this.state.polygonPoints as L.LatLngExpression[], style).addTo(this.map);\r\n      } else if (this.state.currentPolygon) {\r\n        // Update existing polygon\r\n        (this.state.currentPolygon as L.Polygon).setLatLngs(this.state.polygonPoints as L.LatLngExpression[]);\r\n      }\r\n    } catch (error) {\r\n      console.warn('Error adding polygon point:', error);\r\n    }\r\n  }\r\n\r\n  private finishPolygon(): void {\r\n    if (this.state.polygonPoints.length >= 3 && this.state.currentPolygon) {\r\n      const area: DrawnArea = {\r\n        id: Date.now().toString(),\r\n        type: 'polygon',\r\n        coordinates: this.state.polygonPoints,\r\n        name: `${this.config.defaultCategory === 'real_estate' ? 'Property Area' : 'Job Area'} ${this.state.drawnAreas.length + 1}`,\r\n        nameTemplate: this.config.defaultCategory === 'real_estate' ? 'realEstate' : 'job',\r\n        nameNumber: this.state.drawnAreas.length + 1,\r\n        area: this.calculatePolygonArea(this.state.polygonPoints),\r\n        category: this.config.defaultCategory || 'real_estate',\r\n        isVisible: true,\r\n        opacity: 1\r\n      };\r\n\r\n      this.state.drawnAreas.push(area);\r\n      this.handlers.onAreaCreated?.(area);\r\n\r\n      // Reset\r\n      this.state.polygonPoints = [];\r\n      this.state.currentPolygon = null;\r\n      this.setDrawingMode('none');\r\n    }\r\n  }\r\n\r\n  private calculatePolygonArea(coordinates: number[][]): number {\r\n    let area = 0;\r\n    const n = coordinates.length;\r\n\r\n    for (let i = 0; i < n; i++) {\r\n      const j = (i + 1) % n;\r\n      const currentCoord = coordinates[i];\r\n      const nextCoord = coordinates[j];\r\n      if (currentCoord && nextCoord && currentCoord.length >= 2 && nextCoord.length >= 2) {\r\n        area += currentCoord[0]! * nextCoord[1]!;\r\n        area -= nextCoord[0]! * currentCoord[1]!;\r\n      }\r\n    }\r\n\r\n    return Math.abs(area / 2) * 111000 * 111000; // Approximate conversion to square meters\r\n  }\r\n\r\n  public setDrawingMode(mode: DrawingMode): void {\r\n    this.state.activeMode = mode;\r\n    this.handlers.onModeChanged?.(mode);\r\n\r\n    if (mode === 'polygon') {\r\n      this.state.polygonPoints = [];\r\n      this.state.currentPolygon = null;\r\n    }\r\n  }\r\n\r\n  public clearAll(): void {\r\n    if (!this.map) return;\r\n\r\n    try {\r\n      this.map.eachLayer((layer: L.Layer) => {\r\n        // Remove only drawn layers (polygons and markers), not base tiles\r\n        if (layer instanceof L.Polygon || layer instanceof L.Marker) {\r\n          this.map?.removeLayer(layer);\r\n        }\r\n      });\r\n\r\n      this.state.drawnAreas = [];\r\n      this.state.polygonPoints = [];\r\n      this.state.currentPolygon = null;\r\n      this.setDrawingMode('none');\r\n    } catch (error) {\r\n      console.warn('Error clearing drawing layers:', error);\r\n    }\r\n  }\r\n\r\n  public deleteArea(areaId: string): void {\r\n    const areaIndex = this.state.drawnAreas.findIndex(area => area.id === areaId);\r\n    if (areaIndex === -1) return;\r\n\r\n    // Remove from state\r\n    this.state.drawnAreas.splice(areaIndex, 1);\r\n    this.handlers.onAreaDeleted?.(areaId);\r\n\r\n    // TODO: Remove from map - needs layer tracking\r\n  }\r\n\r\n  public getDrawnAreas(): DrawnArea[] {\r\n    return [...this.state.drawnAreas];\r\n  }\r\n\r\n  public getCurrentMode(): DrawingMode {\r\n    return this.state.activeMode;\r\n  }\r\n\r\n  public cleanup(): void {\r\n    if (this.map) {\r\n      this.map.off('click', this.handleMapClick.bind(this));\r\n      this.map.off('dblclick', this.handleDoubleClick.bind(this));\r\n    }\r\n    this.map = null;\r\n    this.state = {\r\n      activeMode: 'none',\r\n      currentPolygon: null,\r\n      polygonPoints: [],\r\n      drawnAreas: []\r\n    };\r\n  }\r\n}","import { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { useMap } from '@layera/map-core';\r\nimport { DrawingService } from '../services/DrawingService';\r\nimport { DrawingMode, DrawnArea, DrawingEventHandlers, DrawingServiceConfig } from '../types';\r\n\r\nexport interface UseDrawingOptions {\r\n  config?: DrawingServiceConfig;\r\n  onAreaCreated?: (area: DrawnArea) => void;\r\n  onAreaDeleted?: (areaId: string) => void;\r\n  onModeChanged?: (mode: DrawingMode) => void;\r\n}\r\n\r\nexport interface UseDrawingReturn {\r\n  drawingService: DrawingService | null;\r\n  currentMode: DrawingMode;\r\n  drawnAreas: DrawnArea[];\r\n  setDrawingMode: (mode: DrawingMode) => void;\r\n  clearAll: () => void;\r\n  deleteArea: (areaId: string) => void;\r\n  isReady: boolean;\r\n}\r\n\r\nexport const useDrawing = (options: UseDrawingOptions = {}): UseDrawingReturn => {\r\n  const { map, isLoading } = useMap();\r\n  const drawingServiceRef = useRef<DrawingService | null>(null);\r\n  const [currentMode, setCurrentMode] = useState<DrawingMode>('none');\r\n  const [drawnAreas, setDrawnAreas] = useState<DrawnArea[]>([]);\r\n  const [isReady, setIsReady] = useState(false);\r\n\r\n  // Initialize drawing service when map is ready\r\n  useEffect(() => {\r\n    if (!map || isLoading) {\r\n      setIsReady(false);\r\n      return;\r\n    }\r\n\r\n    const handlers: DrawingEventHandlers = {\r\n      onAreaCreated: (area) => {\r\n        setDrawnAreas(prev => [...prev, area]);\r\n        options.onAreaCreated?.(area);\r\n      },\r\n      onAreaDeleted: (areaId) => {\r\n        setDrawnAreas(prev => prev.filter(area => area.id !== areaId));\r\n        options.onAreaDeleted?.(areaId);\r\n      },\r\n      onModeChanged: (mode) => {\r\n        setCurrentMode(mode);\r\n        options.onModeChanged?.(mode);\r\n      }\r\n    };\r\n\r\n    drawingServiceRef.current = new DrawingService(options.config);\r\n    drawingServiceRef.current.initialize(map, handlers);\r\n    setIsReady(true);\r\n\r\n    return () => {\r\n      drawingServiceRef.current?.cleanup();\r\n      drawingServiceRef.current = null;\r\n      setIsReady(false);\r\n    };\r\n  }, [map, isLoading, options.config]);\r\n\r\n  const setDrawingMode = useCallback((mode: DrawingMode) => {\r\n    drawingServiceRef.current?.setDrawingMode(mode);\r\n  }, []);\r\n\r\n  const clearAll = useCallback(() => {\r\n    drawingServiceRef.current?.clearAll();\r\n    setDrawnAreas([]);\r\n  }, []);\r\n\r\n  const deleteArea = useCallback((areaId: string) => {\r\n    drawingServiceRef.current?.deleteArea(areaId);\r\n  }, []);\r\n\r\n  return {\r\n    drawingService: drawingServiceRef.current,\r\n    currentMode,\r\n    drawnAreas,\r\n    setDrawingMode,\r\n    clearAll,\r\n    deleteArea,\r\n    isReady\r\n  };\r\n};"],"mappings":"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","names":[]}