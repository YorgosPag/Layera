name: Kit Hub Integration

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  KIT_HUB_PORT: 5173

jobs:
  kit-hub-sync:
    name: ğŸ”„ Kit Hub Sync
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd kit-hub-integration
          npm ci

      - name: ğŸ—ï¸ Build Kit Hub Integration
        run: |
          cd kit-hub-integration
          npm run build

      - name: ğŸ§ª Test Kit Hub Integration
        run: |
          cd kit-hub-integration
          npm run check

      - name: ğŸ“Š Generate Kit Hub Manifest
        run: |
          echo "Generating Kit Hub manifest..."
          node -e "
            const config = require('./.kit-hub.config.json');
            const manifest = {
              name: config.name,
              repository: config.repository.url,
              lastSync: new Date().toISOString(),
              apps: config.structure.apps,
              packages: config.structure.packages,
              technologies: config.technologies,
              features: config.features
            };
            require('fs').writeFileSync('./kit-hub-manifest.json', JSON.stringify(manifest, null, 2));
          "

      - name: ğŸ“ˆ Repository Analytics
        run: |
          echo "ğŸ“Š Repository Analytics for Kit Hub"
          echo "=================================="
          echo "ğŸ“¦ Total Packages: $(ls packages/ | wc -l)"
          echo "ğŸ¯ Total Apps: $(ls apps/ | wc -l)"
          echo "ğŸ“„ TypeScript Files: $(find . -name '*.ts' -o -name '*.tsx' | wc -l)"
          echo "âš›ï¸ React Components: $(find . -name '*.tsx' | wc -l)"
          echo "ğŸ“ Lines of Code: $(find . -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' | xargs wc -l | tail -1)"

          # Kit Hub specific metrics
          echo "ğŸ¯ Kit Hub Metrics"
          echo "=================="
          echo "ğŸ”§ Kit Hub Port: ${{ env.KIT_HUB_PORT }}"
          echo "ğŸ“… Last Update: $(date)"
          echo "ğŸ·ï¸ Current Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"

      - name: ğŸš€ Deploy to Kit Hub (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸš€ Deploying to Kit Hub Production..."
          cd kit-hub-integration
          npm run build
          # Simulation of deployment to Kit Hub
          echo "âœ… Deployed to https://hub.layera.com"

      - name: ğŸ”§ Deploy to Kit Hub (Staging)
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "ğŸ”§ Deploying to Kit Hub Staging..."
          cd kit-hub-integration
          npm run build
          # Simulation of deployment to Kit Hub staging
          echo "âœ… Deployed to https://staging-hub.layera.com"

      - name: ğŸ“¤ Upload Kit Hub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kit-hub-build-${{ github.sha }}
          path: |
            kit-hub-integration/build/
            kit-hub-manifest.json
            .kit-hub.config.json

  enterprise-validation:
    name: ğŸ›¡ï¸ Enterprise Validation
    runs-on: ubuntu-latest
    needs: kit-hub-sync

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Enterprise Validation
        run: |
          echo "ğŸ›¡ï¸ Running Enterprise Validation for Kit Hub..."
          npm run enterprise:validate
          npm run typecheck
          npm run lint

      - name: ğŸ“Š LEGO Systems Compliance
        run: |
          echo "ğŸ§© Checking LEGO Systems Compliance..."
          # Check for LEGO system usage
          LEGO_IMPORTS=$(grep -r "from '@layera/" apps --include="*.ts" --include="*.tsx" | wc -l)
          echo "ğŸ“¦ @layera imports found: $LEGO_IMPORTS"

          # Check for anti-patterns
          STYLED_COMPONENTS=$(grep -r "styled\." apps --include="*.ts" --include="*.tsx" | wc -l)
          echo "âŒ styled-components usage: $STYLED_COMPONENTS"

          # Validate zero duplicates policy
          npm run dup:check

          echo "âœ… LEGO Systems compliance validated"

      - name: ğŸŒ i18n Validation
        run: |
          echo "ğŸŒ Validating i18n compliance..."
          # Check for hardcoded strings
          HARDCODED_GR=$(grep -r "\".*[Î±-Ï‰Î‘-Î©].*\"" apps --include="*.ts" --include="*.tsx" | grep -v "t(" | wc -l)
          HARDCODED_EN=$(grep -r "\"[A-Za-z ].*\"" apps --include="*.ts" --include="*.tsx" | grep -v "t(" | wc -l)

          echo "âŒ Hardcoded Greek strings: $HARDCODED_GR"
          echo "âŒ Hardcoded English strings: $HARDCODED_EN"

          if [ $HARDCODED_GR -gt 0 ] || [ $HARDCODED_EN -gt 0 ]; then
            echo "âš ï¸ Found hardcoded strings - should use t() function"
          else
            echo "âœ… i18n compliance validated"
          fi

  kit-hub-notification:
    name: ğŸ“¢ Kit Hub Notification
    runs-on: ubuntu-latest
    needs: [kit-hub-sync, enterprise-validation]
    if: always()

    steps:
      - name: ğŸ“¢ Success Notification
        if: needs.kit-hub-sync.result == 'success' && needs.enterprise-validation.result == 'success'
        run: |
          echo "ğŸ‰ Kit Hub Integration Successful!"
          echo "âœ… Repository: https://github.com/YorgosPag/Layera"
          echo "âœ… Kit Hub URL: http://localhost:5173"
          echo "âœ… Branch: ${{ github.ref_name }}"
          echo "âœ… Commit: ${{ github.sha }}"

      - name: ğŸ“¢ Failure Notification
        if: needs.kit-hub-sync.result == 'failure' || needs.enterprise-validation.result == 'failure'
        run: |
          echo "âŒ Kit Hub Integration Failed!"
          echo "ğŸ” Check the logs for details"
          echo "ğŸ“ Repository: https://github.com/YorgosPag/Layera"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"