# ğŸ›ï¸ LAYERA ENTERPRISE COMPLIANCE PIPELINE
# Automated enforcement of LEGO Systems ÎºÎ±Î¹ Single Sources of Truth
# Î’Î±ÏƒÎ¹ÏƒÎ¼Î­Î½Î¿ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ±ÎºÏ„Î¹ÎºÎ­Ï‚ Ï„Ï‰Î½ Microsoft, Google, Airbnb, Meta

name: 'ğŸ›¡ï¸ Enterprise Compliance & LEGO Enforcement'

on:
  pull_request:
    branches: ['main', 'develop']
    paths:
      - 'apps/**'
      - 'packages/**'
      - '.eslintrc.cjs'
      - '.husky/**'
      - 'validate-duplicates.js'
  push:
    branches: ['main']
    paths:
      - 'apps/**'
      - 'packages/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9'

jobs:
  # ===============================================
  # LAYER 1: PRE-FLIGHT ENTERPRISE VALIDATION
  # ===============================================
  enterprise-validation:
    name: 'ğŸ” Enterprise Validation & Duplicate Detection'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history Î³Î¹Î± comprehensive analysis

      - name: 'âš™ï¸ Setup Node.js & PNPM'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ“¦ Install PNPM'
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 'ğŸ”§ Install Dependencies'
        run: pnpm install --frozen-lockfile

      - name: 'ğŸ” ENTERPRISE DUPLICATE DETECTION - ZERO TOLERANCE'
        run: |
          echo "ğŸ›¡ï¸ LAYERA ENTERPRISE COMPLIANCE SYSTEM"
          echo "======================================="
          echo "ğŸ¯ Enforcing Single Sources of Truth"
          echo "ğŸ§© Validating LEGO Systems compliance"
          echo ""

          # Run the comprehensive enterprise validation
          pnpm run enterprise:validate

          # Exit code propagation from validate-duplicates.js
          if [ $? -ne 0 ]; then
            echo ""
            echo "âŒ ENTERPRISE COMPLIANCE FAILURE!"
            echo "ğŸš¨ This PR violates Layera enterprise standards"
            echo "ğŸ“‹ Please review CLAUDE.md for compliance requirements"
            exit 1
          fi

          echo ""
          echo "âœ… ENTERPRISE COMPLIANCE: PASSED"
          echo "ğŸ† All Single Sources of Truth validated"
          echo "ğŸ§© LEGO Systems compliance confirmed"

  # ===============================================
  # LAYER 2: LEGO SYSTEMS COMPLIANCE
  # ===============================================
  lego-compliance:
    name: 'ğŸ§© LEGO Systems Compliance Check'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: enterprise-validation

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Node.js & PNPM'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ“¦ Install PNPM'
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 'ğŸ”§ Install Dependencies'
        run: pnpm install --frozen-lockfile

      - name: 'ğŸ§© LEGO Systems Validation'
        run: |
          echo "ğŸ§© LEGO SYSTEMS COMPLIANCE CHECK"
          echo "================================"

          # Count @layera imports
          LEGO_IMPORTS=$(find apps packages -name "*.ts" -o -name "*.tsx" | xargs grep -l "from '@layera/" 2>/dev/null | wc -l)
          TOTAL_TS_FILES=$(find apps packages -name "*.ts" -o -name "*.tsx" | wc -l)

          echo "ğŸ“Š LEGO Usage Statistics:"
          echo "  - Files with @layera imports: $LEGO_IMPORTS"
          echo "  - Total TypeScript files: $TOTAL_TS_FILES"

          if [ "$LEGO_IMPORTS" -lt 50 ]; then
            echo "âš ï¸  WARNING: Low LEGO systems usage detected"
            echo "ğŸ“‹ Consider increasing @layera package usage"
          else
            echo "âœ… Good LEGO systems adoption"
          fi

          # Check for anti-patterns
          echo ""
          echo "ğŸ” Checking for anti-patterns:"

          # styled-components check
          STYLED_COUNT=$(find apps -name "*.ts" -o -name "*.tsx" | xargs grep -l "styled\." 2>/dev/null | wc -l)
          if [ "$STYLED_COUNT" -gt 0 ]; then
            echo "âŒ CRITICAL: $STYLED_COUNT files use styled-components"
            echo "ğŸ§© POLICY: Use @layera components instead"
            exit 1
          fi

          # Custom component implementations
          CUSTOM_COMPONENTS=$(find apps -name "*.ts" -o -name "*.tsx" | xargs grep -E "(const|let|var).*Card.*=|(const|let|var).*Button.*=" 2>/dev/null | wc -l)
          if [ "$CUSTOM_COMPONENTS" -gt 5 ]; then
            echo "âŒ CRITICAL: $CUSTOM_COMPONENTS custom component implementations detected"
            echo "ğŸ§© POLICY: Use @layera/cards, @layera/buttons instead"
            exit 1
          fi

          echo "âœ… LEGO compliance check passed"

  # ===============================================
  # LAYER 3: DESIGN TOKENS ENFORCEMENT
  # ===============================================
  design-tokens:
    name: 'ğŸ¨ Design Tokens & Constants Enforcement'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: lego-compliance

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'ğŸ¨ Design Tokens Validation'
        run: |
          echo "ğŸ¨ DESIGN TOKENS ENFORCEMENT"
          echo "============================"

          # Check for hardcoded colors
          HARDCODED_COLORS=$(find apps -name "*.ts" -o -name "*.tsx" | xargs grep -E "#[0-9a-fA-F]{3,6}|rgb\(|rgba\(" 2>/dev/null | wc -l)
          if [ "$HARDCODED_COLORS" -gt 10 ]; then
            echo "âŒ CRITICAL: $HARDCODED_COLORS hardcoded colors detected"
            echo "ğŸ¨ POLICY: Use design tokens from @layera/tokens"
            exit 1
          fi

          # Check for magic numbers
          MAGIC_NUMBERS=$(find apps -name "*.ts" -o -name "*.tsx" | xargs grep -E "padding.*[0-9]{2,}|margin.*[0-9]{2,}" 2>/dev/null | grep -v "SCALE\|var(" | wc -l)
          if [ "$MAGIC_NUMBERS" -gt 20 ]; then
            echo "âŒ CRITICAL: $MAGIC_NUMBERS magic number usages detected"
            echo "ğŸ¨ POLICY: Use SPACING_SCALE from @layera/constants"
            exit 1
          fi

          # Check for Greek hardcoded strings
          GREEK_STRINGS=$(find apps -name "*.ts" -o -name "*.tsx" | xargs grep -E '"[^"]*[Î±-Ï‰Î‘-Î©][^"]*"' 2>/dev/null | grep -v "t(" | wc -l)
          if [ "$GREEK_STRINGS" -gt 15 ]; then
            echo "âŒ CRITICAL: $GREEK_STRINGS hardcoded Greek strings detected"
            echo "ğŸŒ POLICY: Use t() function for internationalization"
            exit 1
          fi

          echo "âœ… Design tokens enforcement passed"

  # ===============================================
  # LAYER 4: ESLINT & TYPESCRIPT STRICT
  # ===============================================
  code-quality:
    name: 'ğŸ“‹ Code Quality & TypeScript Strict'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: design-tokens

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Node.js & PNPM'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ“¦ Install PNPM'
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 'ğŸ”§ Install Dependencies'
        run: pnpm install --frozen-lockfile

      - name: 'ğŸ“‹ ESLint Validation (Enhanced Rules)'
        run: |
          echo "ğŸ“‹ ESLINT VALIDATION WITH LEGO RULES"
          echo "===================================="
          pnpm run lint

          if [ $? -ne 0 ]; then
            echo "âŒ ESLint validation failed"
            echo "ğŸ§© Check for LEGO compliance violations"
            exit 1
          fi

          echo "âœ… ESLint validation passed"

      - name: 'ğŸ”· TypeScript Strict Mode'
        run: |
          echo "ğŸ”· TYPESCRIPT STRICT VALIDATION"
          echo "==============================="
          pnpm run typecheck

          if [ $? -ne 0 ]; then
            echo "âŒ TypeScript validation failed"
            echo "ğŸ”· Fix type errors and any usage"
            exit 1
          fi

          echo "âœ… TypeScript validation passed"

  # ===============================================
  # LAYER 5: FINAL ENTERPRISE COMPLIANCE REPORT
  # ===============================================
  compliance-report:
    name: 'ğŸ“Š Enterprise Compliance Report'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [enterprise-validation, lego-compliance, design-tokens, code-quality]
    if: always()

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'ğŸ“Š Generate Compliance Report'
        run: |
          echo "ğŸ“Š LAYERA ENTERPRISE COMPLIANCE REPORT"
          echo "======================================"
          echo "ğŸ¯ Single Sources of Truth: âœ… VALIDATED"
          echo "ğŸ§© LEGO Systems Usage: âœ… COMPLIANT"
          echo "ğŸ¨ Design Tokens: âœ… ENFORCED"
          echo "ğŸ“‹ Code Quality: âœ… PASSED"
          echo "ğŸ”· TypeScript Strict: âœ… VERIFIED"
          echo ""
          echo "ğŸ† ENTERPRISE COMPLIANCE STATUS: EXCELLENT"
          echo "ğŸ›¡ï¸ All enterprise standards maintained"
          echo "ğŸš€ Ready for production deployment"
          echo ""
          echo "ğŸ“‹ Compliance Framework:"
          echo "  - Zero Duplicates Policy: ACTIVE"
          echo "  - LEGO Systems Enforcement: ACTIVE"
          echo "  - Single Source of Truth: VALIDATED"
          echo "  - Design Token Usage: ENFORCED"
          echo "  - TypeScript Strict Mode: ENABLED"
          echo "  - i18n Compliance: VERIFIED"

      - name: 'ğŸ‰ Success Summary'
        if: ${{ needs.enterprise-validation.result == 'success' && needs.lego-compliance.result == 'success' && needs.design-tokens.result == 'success' && needs.code-quality.result == 'success' }}
        run: |
          echo ""
          echo "ğŸ‰ Î ÎŸÎ›Î›Î‘ Î£Î¥Î“Î§Î‘Î¡Î—Î¤Î—Î¡Î™Î‘!"
          echo "===================="
          echo "âœ… ÎŒÎ»Î¿Î¹ Î¿Î¹ enterprise Î­Î»ÎµÎ³Ï‡Î¿Î¹ Ï€Î­ÏÎ±ÏƒÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚"
          echo "ğŸ† ÎŸ ÎºÏÎ´Î¹ÎºÎ¬Ï‚ ÏƒÎ¿Ï… ÏƒÏ…Î¼Î¼Î¿ÏÏ†ÏÎ½ÎµÏ„Î±Î¹ 100% Î¼Îµ Ï„Î± Layera standards"
          echo "ğŸ§© Î¤Î­Î»ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ· LEGO Systems"
          echo "ğŸ¯ Zero Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î± ÎµÏ€Î¹Ï„ÎµÏÏ‡Î¸Î·ÎºÎ±Î½"
          echo "ğŸš€ ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚ Î³Î¹Î± merge!"

      - name: 'âŒ Failure Summary'
        if: ${{ needs.enterprise-validation.result == 'failure' || needs.lego-compliance.result == 'failure' || needs.design-tokens.result == 'failure' || needs.code-quality.result == 'failure' }}
        run: |
          echo ""
          echo "âŒ ENTERPRISE COMPLIANCE VIOLATIONS DETECTED"
          echo "============================================"
          echo "ğŸš¨ Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î±"
          echo "ğŸ“‹ Î‘ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎµ Ï„Î¹Ï‚ Î¿Î´Î·Î³Î¯ÎµÏ‚ Ï„Î¿Ï… CLAUDE.md"
          echo "ğŸ§© Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Î¼ÏŒÎ½Î¿ @layera LEGO packages"
          echo "ğŸ¯ Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎµ Single Sources of Truth"
          echo "ğŸ’¡ Î¤ÏÎ­Î¾Îµ 'pnpm run enterprise:validate' Ï„Î¿Ï€Î¹ÎºÎ¬"
          exit 1