#!/usr/bin/env sh
set -e

# 3: CSS lint
pnpm -w exec stylelint "**/*.{css,scss}"

# 3,6: design literals ÎµÎºÏ„ÏŒÏ‚ tokens/styles
if git grep -nE '#[0-9a-fA-F]{3,8}|\brgb\(|\bhsl\(|\b\d+px\b' -- . ':!packages/tokens/**' ':!packages/styles/**' ':!**/*.svg' ':!**/dist/**' ; then
  echo "Policy: design literals outside tokens/styles"; exit 1
fi

# 6: Î±Ï€Î±Î³ÏŒÏÎµÏ…ÏƒÎ· Î¿ÏÎ¹ÏƒÎ¼Î¿Ï --la-* ÎµÎºÏ„ÏŒÏ‚ tokens/styles
if git grep -nE '(^|[;{[:space:]])--la-[a-z0-9-]+[[:space:]]*:' -- ':!packages/tokens/**' ':!packages/styles/**' -- 'apps/**' 'packages/**' ; then
  echo "Policy: defining --la-* outside packages/tokens|styles"; exit 1
fi

# 6: inline styles ÏƒÎµ TS/JSX
if git grep -nE 'zIndex[[:space:]]*:[[:space:]]*[0-9]+' -- '*.ts' '*.tsx' '*.js' '*.jsx' ; then
  echo "Policy: inline zIndex not allowed"; exit 1
fi
if git grep -nE 'fontFamily[[:space:]]*:' -- '*.ts' '*.tsx' '*.js' '*.jsx' ; then
  echo "Policy: inline fontFamily not allowed"; exit 1
fi
if git grep -nE 'boxShadow[[:space:]]*:' -- '*.ts' '*.tsx' '*.js' '*.jsx' ; then
  echo "Policy: inline boxShadow not allowed"; exit 1
fi
if git grep -nE 'borderRadius[[:space:]]*:(?![[:space:]]*var\()' -- '*.ts' '*.tsx' '*.js' '*.jsx' ; then
  echo "Policy: borderRadius must use var(--la-radius-*)"; exit 1
fi

# 4: BULLETPROOF Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î± ÎºÏÎ´Î¹ÎºÎ± - ZERO TOLERANCE
echo "ğŸ”’ ENTERPRISE DUPLICATE DETECTION - BULLETPROOF MODE"
pnpm -w exec jscpd --pattern "**/*.{ts,tsx,js,jsx,css,scss}" -t 0 --ignore "**/dist/**,**/node_modules/**,packages/tokens/**,packages/styles/**,**/*.svg"
if [ $? -ne 0 ]; then
  echo "âŒ BLOCKING COMMIT: Duplicates detected! Enterprise policy violation."
  echo "ğŸš¨ NO DUPLICATES ALLOWED IN ENTERPRISE CODEBASE"
  exit 1
fi
echo "âœ… Duplicate check passed - proceeding"

# 5: import boundaries
pnpm -w imports:check

# 7: ESLint (no-magic-numbers, no-restricted-syntax Îº.Î»Ï€.)
pnpm -w exec eslint "**/*.{ts,tsx,js,jsx}"

# 8â€“9: API contracts
pnpm -w --filter @layera/constants run api:check || true
pnpm -w --filter @layera/ui        run api:check || true
pnpm -w --filter @layera/layout    run api:check || true

# 12: secrets
pnpm -w exec gitleaks protect --staged --redact

# 13: lint-staged for tokens validation
npx --no-install lint-staged